---
/* =========================
 * ⭐ Network Status Config
 * ========================= */

/** 我的固定位置（用于展示 & 距离计算） */
const HOME = {
  label: "浙江省杭州市 / Hangzhou, Zhejiang",
  lat: 30.2741,
  lon: 120.1551,
};

/** 呼吸灯颜色 */
const BREATHING_DOT_COLOR = "#22c55e";

/** 距离数字是否使用主题主色（daisyUI primary） */
const DISTANCE_USE_THEME_COLOR = true;

/** 字体大小：base | lg | xl（更显眼建议 lg/xl） */
const TEXT_SIZE: "base" | "lg" | "xl" = "lg";

/** 文案（想改中文/英文顺序也只改这里） */
const LABELS = {
  myBase: "我的位置 / My base:",
  visitorArea: "访客位置 / Visitor area:",
  distance: "直线距离 / Great-circle distance:",
  loadingArea: "Loading…",
  loadingDist: "Calculating…",
  unavailable: "Unavailable",
  na: "N/A",
};
---

<div
  class="ipline card bg-base-200/70 px-6 py-5 shadow-md"
  style={`--dot-color: ${BREATHING_DOT_COLOR};`}
>
  <!-- 呼吸灯：左上角 -->
  <div class="flex justify-start">
    <span class="breathing-dot" aria-hidden="true"></span>
  </div>

  <!-- 三行信息：居中 -->
  <div class={`mt-2 flex flex-col items-center text-center gap-2 text-${TEXT_SIZE}`}>
    <!-- My base -->
    <div class="font-semibold">
      <span class="text-base-content/70 font-medium">{LABELS.myBase} </span>
      <span class="text-base-content">{HOME.label}</span>
    </div>

    <!-- Visitor area -->
    <div class="font-semibold">
      <span class="text-base-content/70 font-medium">{LABELS.visitorArea} </span>
      <span id="visitor-area" class="text-base-content">{LABELS.loadingArea}</span>
    </div>

    <!-- Distance -->
    <div class="font-semibold">
      <span class="text-base-content/70 font-medium">{LABELS.distance} </span>
      <span
        id="visitor-dist"
        class={DISTANCE_USE_THEME_COLOR ? "distance-accent" : "text-base-content"}
      >
        {LABELS.loadingDist}
      </span>
    </div>
  </div>
</div>

<script is:inline>
  // ⚠️ IMPORTANT: 这里写死同步一份 HOME（避免“上面改了，这里忘改”的坑）
  // 你只需要改文件最上面的 HOME，这里会自动读到（通过 data-* 方式）——见下方改进写法
</script>

<!-- ✅ 用 data-* 把配置传给前端脚本：你只改 frontmatter HOME，这里自动同步 -->
<div
  id="ip-config"
  data-home-lat={HOME.lat}
  data-home-lon={HOME.lon}
  data-loading-area={LABELS.loadingArea}
  data-loading-dist={LABELS.loadingDist}
  data-unavailable={LABELS.unavailable}
  data-na={LABELS.na}
  style="display:none"
></div>

<script is:inline>
  function haversineKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = (x) => (x * Math.PI) / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
    return 2 * R * Math.asin(Math.sqrt(a));
  }

  function pickArea(city, region, country) {
    // 只显示大概：优先 city+country，否则 region+country，否则 country
    if (city) return country ? `${city}, ${country}` : city;
    if (region) return country ? `${region}, ${country}` : region;
    return country || "";
  }

  async function fetchJSON(url, timeoutMs = 4000) {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      const res = await fetch(url, { signal: ctrl.signal });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    } finally {
      clearTimeout(timer);
    }
  }

  const cfgEl = document.getElementById("ip-config");
  const HOME_LAT = Number(cfgEl?.dataset.homeLat);
  const HOME_LON = Number(cfgEl?.dataset.homeLon);
  const TXT_UNAVAILABLE = cfgEl?.dataset.unavailable || "Unavailable";
  const TXT_NA = cfgEl?.dataset.na || "N/A";

  const elArea = document.getElementById("visitor-area");
  const elDist = document.getElementById("visitor-dist");

  function setFallback() {
    if (elArea) elArea.textContent = TXT_UNAVAILABLE;
    if (elDist) elDist.textContent = TXT_NA;
  }

  async function main() {
    try {
      // 1) ipapi.co（可能被拦/不稳定）
      try {
        const d = await fetchJSON("https://ipapi.co/json/");
        const city = d.city || "";
        const region = d.region || "";
        const country = d.country_name || "";
        const lat = Number(d.latitude);
        const lon = Number(d.longitude);

        const area = pickArea(city, region, country) || TXT_UNAVAILABLE;
        if (elArea) elArea.textContent = area;

        if (Number.isFinite(lat) && Number.isFinite(lon) && Number.isFinite(HOME_LAT) && Number.isFinite(HOME_LON)) {
          const km = haversineKm(HOME_LAT, HOME_LON, lat, lon);
          if (elDist) elDist.textContent = `${km.toFixed(0)} km`;
        } else {
          if (elDist) elDist.textContent = TXT_NA;
        }
        return; // ✅ 成功就结束
      } catch (e) {
        // fall through
      }

      // 2) fallback: ipinfo.io（无需 token 也能给 city/region/country + loc）
      const d2 = await fetchJSON("https://ipinfo.io/json");
      const city2 = d2.city || "";
      const region2 = d2.region || "";
      const country2 = d2.country || ""; // 这里是国家代码
      const loc = (d2.loc || "").split(",");
      const lat2 = Number(loc[0]);
      const lon2 = Number(loc[1]);

      const area2 = pickArea(city2, region2, country2) || TXT_UNAVAILABLE;
      if (elArea) elArea.textContent = area2;

      if (Number.isFinite(lat2) && Number.isFinite(lon2) && Number.isFinite(HOME_LAT) && Number.isFinite(HOME_LON)) {
        const km2 = haversineKm(HOME_LAT, HOME_LON, lat2, lon2);
        if (elDist) elDist.textContent = `${km2.toFixed(0)} km`;
      } else {
        if (elDist) elDist.textContent = TXT_NA;
      }
    } catch (e) {
      setFallback(); // ✅ 无论如何不会永远 loading
    }
  }

  // 如果 DOM 还没 ready，确保在 ready 后跑（避免偶发找不到元素导致一直 loading）
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", main);
  } else {
    main();
  }
</script>

<style>
  .breathing-dot {
    width: 12px;
    height: 12px;
    border-radius: 999px;
    background: var(--dot-color);
    box-shadow: 0 0 0 0 rgba(0,0,0,0);
    animation: breathe 1.8s ease-in-out infinite;
  }

  @keyframes breathe {
    0%   { transform: scale(0.85); opacity: 0.55; }
    50%  { transform: scale(1.15); opacity: 1; box-shadow: 0 0 0 10px rgba(0,0,0,0.15); }
    100% { transform: scale(0.85); opacity: 0.55; }
  }

  .distance-accent {
    color: hsl(var(--p));
  }
</style>
