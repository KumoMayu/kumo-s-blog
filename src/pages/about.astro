---
import { Icon } from "astro-icon/components";
import MainCard from "@/components/MainCard.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";

/** ⭐ 常用信息集中放这里：以后改链接最方便 */
const PROFILE = {
  name: "KumoMayu",
  tagline: "XJTU 自动化 / Automation",
  avatar: "https://github.com/KumoMayu.png",
  links: {
    github: "https://github.com/KumoMayu",
    instagram: "https://www.instagram.com/ng_tungho/",
    email: "mailto:kumomayu@outlook.com",
  },
  introLines: [
    "摸鱼者 / Slacker",
    "模拟经营游戏玩家 / Simulation game player",
    "内容创作者 / Content creator",
    "世界探索者 / World explorer",
  ],
};

/**
 * ⭐ 足迹城市配置（你以后主要改这里）
 * visits: 到访次数（用于颜色分级）
 * tags: 可选：home / thisYear
 *
 * 可选加字段：
 * note: "2026-01-01 解锁该城市"
 */
const FOOTPRINTS_CITIES = [
  // 常驻地：红色（你指定）
  {
    name: "杭州 Hangzhou",
    lat: 30.2741,
    lon: 120.1551,
    visits: 8,
    tags: ["home"],
    note: "2026-01-01 解锁该城市",
  },
  {
    name: "西安 Xi'an",
    lat: 34.3416,
    lon: 108.9398,
    visits: 8,
    tags: ["home"],
    note: "2026-01-01 解锁该城市",
  },

  // 示例：今年到访（你指定先用宁波做效果）
  {
    name: "宁波 Ningbo",
    lat: 29.8683,
    lon: 121.544,
    visits: 3,
    tags: ["thisYear"],
    note: "2026-01-01 解锁该城市",
  },

  // 示例：一些城市（你随时删/改/加）
  {
    name: "上海 Shanghai",
    lat: 31.2304,
    lon: 121.4737,
    visits: 2,
    tags: [],
    note: "2026-01-01 解锁该城市",
  },
  {
    name: "北京 Beijing",
    lat: 39.9042,
    lon: 116.4074,
    visits: 1,
    tags: [],
    note: "2026-01-01 解锁该城市",
  },
  {
    name: "南京 Nanjing",
    lat: 32.0603,
    lon: 118.7969,
    visits: 1,
    tags: [],
    note: "2026-01-01 解锁该城市",
  },
];

/** 颜色分级：按 visits 映射到你要的红/橙/紫/蓝/绿 */
function levelOf(
  visits: number,
): "red" | "orange" | "purple" | "blue" | "green" {
  if (visits >= 6) return "red";
  if (visits >= 3) return "orange";
  if (visits >= 2) return "purple";
  if (visits >= 1) return "blue";
  return "green";
}
---

<BaseLayout title="About">
  <MainCard
    title={`关于 ${PROFILE.name}`}
    description={PROFILE.tagline}
    textOverlay="浮生一记"
    infoIcon="lucide:user"
  >
    <div class="space-y-10 mb-8">
      <!-- Profile Section -->
      <section class="flex flex-col md:flex-row gap-8 items-center md:items-start">
        <div class="avatar">
          <div class="w-32 h-32 md:w-40 md:h-40 rounded-xl ring ring-primary ring-offset-base-100 ring-offset-2 overflow-hidden">
            <img src={PROFILE.avatar} alt={PROFILE.name} width="160" height="160" loading="eager" />
          </div>
        </div>

        <div class="flex-1 text-center md:text-left">
          <h1 class="text-3xl md:text-4xl font-bold mb-2">{PROFILE.name}</h1>
          <p class="text-xl text-base-content/80 mb-4">{PROFILE.tagline}</p>

          <div class="flex flex-wrap gap-3 justify-center md:justify-start mb-6">
            <a href={PROFILE.links.github} target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline gap-2">
              <Icon name="lucide:github" class="w-4 h-4" />
              <span>GitHub</span>
            </a>

            <a href={PROFILE.links.instagram} target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline gap-2">
              <Icon name="lucide:instagram" class="w-4 h-4" />
              <span>Instagram</span>
            </a>

            <a href={PROFILE.links.email} class="btn btn-sm btn-outline gap-2">
              <Icon name="lucide:mail" class="w-4 h-4" />
              <span>Email</span>
            </a>
          </div>

          <div class="text-base-content/80 space-y-2">
            {PROFILE.introLines.map((line) => <p>{line}</p>)}
          </div>
        </div>
      </section>

      <!-- Footprints -->
      <section>
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="lucide:map-pin" class="w-6 h-6 text-primary" />
          <span>足迹 / Footprints</span>
        </h2>

        <div class="card bg-base-200 p-6 shadow-md">
          <div class="flex flex-col gap-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <p class="text-sm text-base-content/70">
                <b>已探索区域 / Cities explored</b>
              </p>

              <div class="join">
                <button id="btnAll" class="btn btn-sm join-item btn-primary" type="button">全部</button>
                <button id="btnThisYear" class="btn btn-sm join-item btn-outline" type="button">今年到访</button>
              </div>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap gap-3 text-sm items-center">
              <span class="font-medium text-base-content/70">频次 / Frequency: </span>
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span><span class="text-base-content/70">V</span></span>
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-500"></span><span class="text-base-content/70">IV</span></span>
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-purple-500"></span><span class="text-base-content/70">III</span></span>
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span><span class="text-base-content/70">II</span></span>
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span><span class="text-base-content/70">I</span></span>
            </div>

            <div class="bg-base-100/60 rounded-xl p-3 overflow-hidden">
              <div class="rounded-xl overflow-hidden bg-base-100 shadow">
                <svg
                  id="footprintMap"
                  viewBox="0 0 1000 680"
                  preserveAspectRatio="xMidYMid meet"
                  class="w-full h-[420px] md:h-[520px]"
                  role="img"
                  aria-label="Footprints world map"
                >
                  <defs>
                    <linearGradient id="seaGrad" x1="0" y1="0" x2="1" y2="1">
                      <stop offset="0%" stop-color="rgba(59,130,246,0.10)"></stop>
                      <stop offset="100%" stop-color="rgba(168,85,247,0.07)"></stop>
                    </linearGradient>

                    <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                      <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(100,116,139,0.12)" stroke-width="1" />
                    </pattern>
                  </defs>

                  <!-- background -->
                  <rect x="0" y="0" width="1000" height="680" fill="url(#seaGrad)" />
                  <rect x="0" y="0" width="1000" height="680" fill="url(#grid)" />
                  <rect x="18" y="18" width="964" height="644" rx="22" ry="22" fill="none" stroke="rgba(100,116,139,0.22)" />

                  <!-- pan/zoom -->
                  <g id="viewport">
                    <!-- land silhouette -->
                    <image
                      href="/maps/world-land.svg"
                      x="0"
                      y="0"
                      width="1000"
                      height="680"
                      preserveAspectRatio="xMidYMid slice"
                      opacity="0.30"
                      style="filter: brightness(1.18) contrast(0.95);"
                    />

                    <!-- city points -->
                    {
                      FOOTPRINTS_CITIES.map((c) => {
                        const lv = levelOf(c.visits);
                        const dot =
                          lv === "red" ? "fill-red-500" :
                          lv === "orange" ? "fill-orange-500" :
                          lv === "purple" ? "fill-purple-500" :
                          lv === "blue" ? "fill-blue-500" : "fill-green-500";

                        const tags = c.tags || [];
                        const isHome = tags.includes("home");
                        const isThisYear = tags.includes("thisYear");
                        const showLabelByDefault = isHome || isThisYear;

                        return (
                          <g
                            class="city-point cursor-pointer"
                            data-lon={String(c.lon)}
                            data-lat={String(c.lat)}
                            data-tags={tags.join(",")}
                            data-name={c.name}
                            data-note={c.note ?? "2026-01-01 解锁该城市"}
                            data-label-default={showLabelByDefault ? "1" : "0"}
                          >
                            <!-- halo + dot (你要求统一) -->
                            <circle r="1.5" fill="rgba(255,255,255,0.60)" />
                            <circle r="1" class={dot} />
                            <!-- label：默认隐藏（你要求地图上不显示文字） -->
                            <text class="city-label" style="display:none"></text>
                          </g>
                        );
                      })
                    }
                  </g>
                </svg>
              </div>

              <div class="mt-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <p class="text-xs text-base-content/60 leading-relaxed">
                  <span class="block">滚轮缩放、拖拽移动，单击城市点可查看更多内容。</span>
                  <span class="hidden md:block">Supports zooming and panning; click a city point to view more details.</span>
                </p>
                <button id="btnReset" class="btn btn-xs btn-outline w-fit" type="button">
                  重置视图
                </button>
              </div>

              <div class="alert bg-base-100/60">
                <Icon name="lucide:info" class="w-5 h-5" />
                <span class="text-sm">
                  <span>非完全数据，</span>
                  <span class="thick-s">持续</span>
                  <span>随缘更新中，<b>保障个人隐私</b> / Incomplete data in progress &amp; <b>Protect privacy</b></span>

                  <style>
                    .thick-s {
                      position: relative;
                      display: inline-block;
                      white-space: nowrap;
                    }
                    .thick-s::after {
                      content: "";
                      position: absolute;
                      left: 0;
                      right: 0;
                      top: 52%;
                      height: 2.5px;
                      background: currentColor;
                      transform: translateY(-50%);
                      pointer-events: none;
                    }
                  </style>
                </span>
              </div>
            </div>
          </div>
        </div>

        <script is:inline>
          const svg = document.getElementById("footprintMap");
          const viewport = document.getElementById("viewport");
          const btnAll = document.getElementById("btnAll");
          const btnThisYear = document.getElementById("btnThisYear");
          const btnReset = document.getElementById("btnReset");

          const VIEW_W = 1000;
          const VIEW_H = 680;

          const DEFAULT_CENTER = { lon: 115, lat: 30 };
          const DEFAULT_SCALE = 7;

          const MIN_SCALE = 1.0;
          const MAX_SCALE = 40.0;

          // ====== 你只需要调这里来“凑参数” ======
          // 偏东 -> lonBiasDeg 增大；偏西 -> 减小
          // 偏南 -> latBiasDeg 增大；偏北 -> 减小
          // lonScale/latScale: 只用来修正整体比例（很小幅度，如 0.995~1.005）
          const TUNE = {
            lonBiasDeg: -35.5,
            latBiasDeg: 13.7,
            lonScale: 1.0,
            latScale: 1.0,
          };

          function clamp(v, min, max) {
            return Math.max(min, Math.min(max, v));
          }

          // ====== Mercator（如果你的 world-land.svg 是墨卡托矩形世界图） ======
          function mercatorY01(latDeg) {
            const lat = clamp(latDeg, -85, 85) * Math.PI / 180;
            const y = Math.log(Math.tan(Math.PI / 4 + lat / 2));
            const yMin = Math.log(Math.tan(Math.PI / 4 + (-85 * Math.PI / 180) / 2));
            const yMax = Math.log(Math.tan(Math.PI / 4 + ( 85 * Math.PI / 180) / 2));
            return (yMax - y) / (yMax - yMin); // 0 top, 1 bottom
          }

          // ====== 关键：获取底图在 viewBox 中“实际显示”的矩形 ======
          // 这一步让点映射永远和 <image preserveAspectRatio="..."> 保持一致
          function getImageBoxInViewBox() {
            const img = viewport.querySelector('image[href="/maps/world-land.svg"], image[xlink\\:href="/maps/world-land.svg"]')
              || viewport.querySelector("image");
            if (!img) {
              // fallback：就当全铺满
              return { x: 0, y: 0, w: VIEW_W, h: VIEW_H };
            }

            // 你写的是 width=1000 height=680；但 slice/meet 可能导致实际“有效绘制区域”裁切
            // 最稳：用 getBBox 获取在当前用户坐标系里的实际 bbox（不依赖你猜原始尺寸）
            try {
              const bb = img.getBBox();
              // bb 是 image 元素自身在 viewBox 坐标的矩形（通常就是 0..1000, 0..680）
              // 但 slice 的“裁切”发生在 image 内部，不会反映到 bbox。
              // 所以我们还需要用 preserveAspectRatio 的规则，算出“图像内容”在该 bbox 内的可见区域。
              const x = bb.x, y = bb.y, w = bb.width, h = bb.height;

              // 读取你写在 <image> 上的 preserveAspectRatio（默认 xMidYMid meet）
              const par = (img.getAttribute("preserveAspectRatio") || "xMidYMid meet").trim();
              const isSlice = /\bslice\b/i.test(par); // 你现在是 slice

              // 读取“原始资源宽高”：无法从 SVG image 标签直接拿到文件内部 viewBox，
              // 所以这里给一个可调的“资源比例”参数（只影响裁切计算，不影响投影本身）
              // 你说资源 800×387，就写这里；如果以后换图只改这里即可
              const SRC_W = 800;
              const SRC_H = 387;

              const sx = w / SRC_W;
              const sy = h / SRC_H;
              const s = isSlice ? Math.max(sx, sy) : Math.min(sx, sy); // slice=cover, meet=contain

              const drawW = SRC_W * s;
              const drawH = SRC_H * s;

              // xMidYMid：居中
              const dx = (w - drawW) / 2;
              const dy = (h - drawH) / 2;

              // 图像内容实际绘制区域（可能超出 bb，超出的部分会被裁掉）
              // 我们要用“bb 内的那一块”作为点位映射目标，所以返回 bb 本身，
              // 同时在 project 里用 dx/dy/s 把点从“资源坐标”映射到 bb。
              return { x, y, w, h, s, dx, dy, srcW: SRC_W, srcH: SRC_H };
            } catch {
              return { x: 0, y: 0, w: VIEW_W, h: VIEW_H, s: 1, dx: 0, dy: 0, srcW: 800, srcH: 387 };
            }
          }

          // ====== 经纬度 -> 点坐标（严格和底图裁切/比例一致）======
          function project(lon, lat) {
            const imgBox = getImageBoxInViewBox();

            const lonAdj = (lon + TUNE.lonBiasDeg) * TUNE.lonScale;
            const latAdj = (lat + TUNE.latBiasDeg) * TUNE.latScale;

            // 先到“资源坐标系”（0..SRC_W / 0..SRC_H）
            const x0 = ((lonAdj + 180) / 360) * imgBox.srcW;
            const y0 = mercatorY01(latAdj) * imgBox.srcH;

            // 再按 preserveAspectRatio 的缩放与偏移映射到 viewBox
            const x = imgBox.x + (x0 * imgBox.s + imgBox.dx);
            const y = imgBox.y + (y0 * imgBox.s + imgBox.dy);

            return { x, y };
          }

          function layoutPoints() {
            const points = svg.querySelectorAll(".city-point");
            points.forEach((p) => {
              const lon = Number(p.getAttribute("data-lon"));
              const lat = Number(p.getAttribute("data-lat"));
              if (!isFinite(lon) || !isFinite(lat)) return;

              const { x, y } = project(lon, lat);
              p.setAttribute("transform", `translate(${x.toFixed(2)}, ${y.toFixed(2)})`);
            });
          }

          // ====== 平移缩放 ======
          let scale = 1;
          let tx = 0;
          let ty = 0;
          let mode = "all";

          function clampToFrame() {
            const minTx = VIEW_W - VIEW_W * scale;
            const maxTx = 0;
            const minTy = VIEW_H - VIEW_H * scale;
            const maxTy = 0;
            tx = clamp(tx, minTx, maxTx);
            ty = clamp(ty, minTy, maxTy);
          }

          function applyTransform() {
            clampToFrame();
            viewport.setAttribute("transform", `translate(${tx}, ${ty}) scale(${scale})`);
          }

          function applyMode() {
            const points = svg.querySelectorAll(".city-point");
            points.forEach((p) => {
              const tags = (p.getAttribute("data-tags") || "").split(",").map(s => s.trim()).filter(Boolean);
              const show = mode === "all" ? true : tags.includes("thisYear");
              p.style.display = show ? "block" : "none";
            });
          }

          function setMode(nextMode) {
            mode = nextMode;
            if (btnAll && btnThisYear) {
              if (mode === "all") {
                btnAll.classList.add("btn-primary");
                btnAll.classList.remove("btn-outline");
                btnThisYear.classList.add("btn-outline");
                btnThisYear.classList.remove("btn-primary");
              } else {
                btnThisYear.classList.add("btn-primary");
                btnThisYear.classList.remove("btn-outline");
                btnAll.classList.add("btn-outline");
                btnAll.classList.remove("btn-primary");
              }
            }
            applyMode();
          }

          function setViewToCenterLonLat(centerLon, centerLat, nextScale) {
            scale = clamp(nextScale, MIN_SCALE, MAX_SCALE);
            const { x, y } = project(centerLon, centerLat);
            tx = VIEW_W / 2 - x * scale;
            ty = VIEW_H / 2 - y * scale;
            applyTransform();
          }

          // ====== 屏幕坐标 -> viewBox 坐标（dev/prod 一致）======
          function toSvgPoint(clientX, clientY) {
            const pt = svg.createSVGPoint();
            pt.x = clientX;
            pt.y = clientY;
            const ctm = svg.getScreenCTM();
            if (!ctm) return { x: VIEW_W / 2, y: VIEW_H / 2 };
            const p = pt.matrixTransform(ctm.inverse());
            return { x: p.x, y: p.y };
          }

          // ====== 缩放：鼠标为中心 ======
          svg?.addEventListener("wheel", (e) => {
            e.preventDefault();
            const delta = Math.sign(e.deltaY);
            const factor = delta > 0 ? 0.90 : 1.12;
            const next = clamp(scale * factor, MIN_SCALE, MAX_SCALE);

            const { x: cx, y: cy } = toSvgPoint(e.clientX, e.clientY);
            tx = cx - (cx - tx) * (next / scale);
            ty = cy - (cy - ty) * (next / scale);
            scale = next;
            applyTransform();
            hideTip?.();
          }, { passive: false });

          // ====== 拖拽平移 ======
          let dragging = false;
          let lastP = null;

          svg?.addEventListener("mousedown", (e) => {
            dragging = true;
            lastP = toSvgPoint(e.clientX, e.clientY);
            hideTip?.();
          });
          window.addEventListener("mouseup", () => { dragging = false; lastP = null; });
          window.addEventListener("mousemove", (e) => {
            if (!dragging || !lastP) return;
            const p = toSvgPoint(e.clientX, e.clientY);
            tx += (p.x - lastP.x);
            ty += (p.y - lastP.y);
            lastP = p;
            applyTransform();
          });

          // ====== 点击提示（保留你原来的 tip 逻辑即可）======
          let tipEl = null;

          function ensureTip() {
            if (tipEl) return tipEl;
            tipEl = document.createElement("div");
            tipEl.id = "cityTip";
            tipEl.style.position = "fixed";
            tipEl.style.zIndex = "50";
            tipEl.style.maxWidth = "260px";
            tipEl.style.pointerEvents = "auto";
            tipEl.style.display = "none";
            tipEl.className = "card bg-base-100 shadow-lg border border-base-200 rounded-xl";
            tipEl.innerHTML = `
              <div class="card-body p-4">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div id="tipTitle" class="font-bold text-base"></div>
                    <div id="tipNote" class="text-sm text-base-content/70 mt-1"></div>
                  </div>
                  <button id="tipClose" class="btn btn-ghost btn-xs">✕</button>
                </div>
              </div>
            `;
            document.body.appendChild(tipEl);
            tipEl.querySelector("#tipClose").addEventListener("click", hideTip);
            window.addEventListener("click", (ev) => {
              if (!tipEl || tipEl.style.display === "none") return;
              if (tipEl.contains(ev.target)) return;
              const isPoint = ev.target && ev.target.closest && ev.target.closest(".city-point");
              if (!isPoint) hideTip();
            });
            return tipEl;
          }

          function hideTip() {
            if (!tipEl) return;
            tipEl.style.display = "none";
          }

          function showTipForPoint(pointEl, clientX, clientY) {
            const tip = ensureTip();
            const name = pointEl.getAttribute("data-name") || "Unknown";
            const note = pointEl.getAttribute("data-note") || "（未填写解锁信息）";
            tip.querySelector("#tipTitle").textContent = name;
            tip.querySelector("#tipNote").textContent = note;

            const pad = 12;
            const vw = window.innerWidth;
            const vh = window.innerHeight;

            tip.style.display = "block";
            tip.style.left = "0px";
            tip.style.top = "0px";

            const rect = tip.getBoundingClientRect();
            let left = clientX + pad;
            let top = clientY + pad;

            if (left + rect.width > vw - 10) left = clientX - rect.width - pad;
            if (top + rect.height > vh - 10) top = clientY - rect.height - pad;

            tip.style.left = `${Math.max(10, left)}px`;
            tip.style.top = `${Math.max(10, top)}px`;
          }

          svg?.addEventListener("click", (e) => {
            const target = e.target;
            const p = target && target.closest ? target.closest(".city-point") : null;
            if (!p) return;
            if (p.style.display === "none") return;
            showTipForPoint(p, e.clientX, e.clientY);
          });

          // ====== buttons ======
          btnReset?.addEventListener("click", () => {
            setViewToCenterLonLat(DEFAULT_CENTER.lon, DEFAULT_CENTER.lat, DEFAULT_SCALE);
          });
          btnAll?.addEventListener("click", () => setMode("all"));
          btnThisYear?.addEventListener("click", () => setMode("thisYear"));

          // ====== init（等图片加载后再 layout，一次性解决“第一次偏移”）======
          function init() {
            layoutPoints();
            setMode("all");
            setViewToCenterLonLat(DEFAULT_CENTER.lon, DEFAULT_CENTER.lat, DEFAULT_SCALE);
          }

          // image 资源未必立刻 ready：等一帧 + 监听 load
          const imgEl = viewport.querySelector("image");
          if (imgEl) {
            imgEl.addEventListener("load", () => init(), { once: true });
          }
          requestAnimationFrame(() => init());
        </script>
      </section>


      <!-- Contribution Activity -->
      <section class="mt-8">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="lucide:activity" class="w-6 h-6 text-primary" />
          <span>近期活动 / Recent Activity</span>
        </h2>

        <div class="bg-base-200 rounded-xl p-6 overflow-x-auto">
          <div class="flex flex-col md:flex-row gap-8 md:gap-4 md:overflow-x-auto md:pb-2">
            {
              [
                { date: "Jan 14, 2026", title: "博客建立 Blog established", desc: "Hello World!" },
                { date: "Jan 26, 2026", title: "持续更新中 Continuously updating", desc: "欢迎持续关注 Welcome to continue to visit" },
              ].map((item, i) => (
                <div class="relative flex gap-4 pb-2 md:pb-0 md:min-w-[250px]">
                  <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-primary-content text-xl">
                      {i + 1}
                    </div>
                    <div class="w-0.5 h-16 bg-base-300 mt-2 md:hidden" />
                  </div>
                  <div>
                    <div class="text-sm text-base-content/60 mb-1">{item.date}</div>
                    <h3 class="text-lg font-bold">{item.title}</h3>
                    <p class="text-base-content/80 mt-1">{item.desc}</p>
                  </div>
                </div>
              ))
            }
          </div>
        </div>
      </section>
    </div>
  </MainCard>
</BaseLayout>
